name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - feature/**
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==================== Linting ====================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 black isort bandit
      
      - name: Run Black code formatter check
        run: black --check --diff api/ services/ scripts/
        continue-on-error: true
      
      - name: Run isort import sorter check
        run: isort --check-only --diff api/ services/ scripts/
        continue-on-error: true
      
      - name: Run Flake8 linter
        run: |
          flake8 api/ services/ scripts/ \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --max-line-length=120
        continue-on-error: true
      
      - name: Run Pylint
        run: pylint api/ services/ scripts/ --exit-zero --max-line-length=120
        continue-on-error: true
      
      - name: Run Bandit security check
        run: bandit -r api/ services/ scripts/ -v
        continue-on-error: true
      
      - name: Report status
        run: echo "✅ Linting checks completed"

  # ==================== Tests ====================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
          MONGO_INITDB_DATABASE: omnisearch
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
      
      weaviate:
        image: semitechnologies/weaviate:1.24.1
        env:
          AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
        options: >-
          --health-cmd "curl -f http://localhost:8080/v1/.well-known/ready || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8080:8080
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libpq-dev
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Wait for services
        run: |
          echo "Waiting for MongoDB..."
          python -c "
          import pymongo
          import time
          for i in range(30):
              try:
                  client = pymongo.MongoClient('mongodb://admin:password@localhost:27017/')
                  client.admin.command('ping')
                  print('✓ MongoDB is ready')
                  break
              except:
                  if i < 29:
                      time.sleep(1)
                  else:
                      raise
          "
          
          echo "Waiting for Weaviate..."
          for i in {1..30}; do
            curl -f http://localhost:8080/v1/.well-known/ready && echo "✓ Weaviate is ready" && break
            sleep 1
          done
      
      - name: Run unit tests
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --cov=api \
            --cov=services \
            --cov-report=xml \
            --cov-report=term-missing \
            -p no:warnings
        env:
          MONGODB_URL: mongodb://admin:password@localhost:27017
          WEAVIATE_URL: http://localhost:8080
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Generate coverage badge
        run: |
          echo "Coverage report generated"
        continue-on-error: true
      
      - name: Report test results
        if: always()
        run: echo "✅ Tests completed"

  # ==================== Docker Build ====================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push FastAPI image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
      
      - name: Build and push Embedding service image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.embedding
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/embedding:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/embedding:${{ github.sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/embedding:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/embedding:buildcache,mode=max
      
      - name: Image digest
        run: echo "✅ Docker images built successfully"

  # ==================== Integration Tests ====================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
          MONGO_INITDB_DATABASE: omnisearch
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
      
      weaviate:
        image: semitechnologies/weaviate:1.24.1
        env:
          AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
        options: >-
          --health-cmd "curl -f http://localhost:8080/v1/.well-known/ready || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8080:8080
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run integration tests
        run: |
          pytest tests/ \
            -v \
            -m integration \
            --tb=short \
            -p no:warnings
        env:
          MONGODB_URL: mongodb://admin:password@localhost:27017
          WEAVIATE_URL: http://localhost:8080
          PYTHONPATH: ${{ github.workspace }}
        continue-on-error: true
      
      - name: Report integration test results
        run: echo "✅ Integration tests completed"

  # ==================== Status Check ====================
  status:
    name: Workflow Status
    runs-on: ubuntu-latest
    needs: [lint, test, build, integration]
    if: always()
    
    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ All checks passed!"
            exit 0
          else
            echo "❌ Some checks failed"
            echo "Lint: ${{ needs.lint.result }}"
            echo "Test: ${{ needs.test.result }}"
            echo "Build: ${{ needs.build.result }}"
            echo "Integration: ${{ needs.integration.result }}"
            exit 1
          fi
      
      - name: Create status report
        if: always()
        run: |
          cat > /tmp/status.txt << EOF
          Workflow Status Report
          ======================
          
          Lint: ${{ needs.lint.result }}
          Test: ${{ needs.test.result }}
          Build: ${{ needs.build.result }}
          Integration: ${{ needs.integration.result }}
          
          Run ID: ${{ github.run_id }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          EOF
          cat /tmp/status.txt
